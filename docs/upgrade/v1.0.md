# Bamboo v1.0 Upgrade Guide

This guide walks 0.x installations through the final steps required to adopt the
v1.0 contract freeze. It assumes the application already targets Bamboo v0.4 and
OpenSwoole deployments.

## Audience and prerequisites

- Source application currently running on Bamboo `^0.4`.
- PHP 8.4 with the cURL, OpenSwoole, and Redis extensions available.
- Access to the deployment environment to update system packages and restart the
  HTTP workers.

Before proceeding, confirm the toolchain versions:

```
php -v
php --ri openswoole | grep Version
```

## Step-by-step upgrade flow

1. **Back up configuration and environment files.**
   - Commit local changes or create copies of `.env` and the `etc/` directory.

2. **Update Composer dependencies.**
   - Bump Bamboo to the v1.0 constraint: `composer require greenarmor/bamboo:^1.0`.
   - Run `composer install` to download updated packages.

3. **Run configuration validation.**
   - Execute `composer validate:config` to run the new `config.validate` command.
   - Address reported issues (missing keys, empty secrets, invalid timeouts) before
     continuing.

4. **Adopt new configuration files.**
   - Copy `etc/resilience.php` and merge any project-specific overrides. This file
     defines timeout and circuit breaker defaults consumed by the new middleware.
   - Ensure `etc/middleware.php` contains
     `Bamboo\Web\Middleware\CircuitBreakerMiddleware::class` and
     `Bamboo\Web\Middleware\TimeoutMiddleware::class` in the global stack. Custom
     configurations should merge these entries into their own arrays.

5. **Review module bootstrapping.**
   - Applications relying on modules must update `etc/modules.php` to include
     module classes explicitly; v1.0 treats module order as part of the public
     contract documented in `docs/modules.md`.

6. **Refresh the route cache (if used).**
   - Run `php bin/bamboo routes.cache` after the application boots locally to
     regenerate `var/cache/routes.cache.php` without closures.

7. **Validate operational scripts.**
   - Update CI pipelines to call `composer validate:config` alongside linting and
     tests.
   - Add `php bin/bench/http --label="pre-release"` to capture baseline numbers
     for regression monitoring.

8. **Smoke-test the application.**
   - `php bin/bamboo http.serve` locally; verify `/`, `/metrics`, `/healthz`, and
     `/readyz` respond as expected.
   - Run the integration test suite (`composer test`).

9. **Deploy.**
   - Publish the updated Docker image or artefact.
   - Monitor `/metrics` and the new circuit breaker metrics for anomalies during
     the first traffic window.

## Compatibility matrix

| Component | Supported versions |
|-----------|--------------------|
| PHP | 8.4.x |
| OpenSwoole | 22.1 or newer (built with coroutine and HTTP/WS support) |
| Redis | 6.x or newer |
| Prometheus client | `promphp/prometheus_client_php` ^2.7 |

## Deprecations lifted in v1.0

No runtime deprecations remained pending for v1.0. The release formalises the
configuration schema, router behaviour, and CLI command catalogue introduced
throughout the 0.4 series. Future deprecations will be announced with warning
emissions, upgrade notes, and automated tooling per the policies captured in the
CLI and configuration references.

## Additional resources

- [CLI reference](../cli/README.md)
- [Router contract](../router.md)
- [Configuration overview](../configuration/overview.md)
- [Performance benchmark playbook](../benchmarks/README.md)
- [Starter blueprint hub](../starters/README.md)

For further assistance, open a discussion on the project repository or join the
community chat linked from the README.
