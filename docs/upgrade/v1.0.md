# Bamboo v1.0 Upgrade Guide

The v1.0 release locks Bamboo's public contracts for the 1.x line. This guide walks through the required environment checks, dependency bumps, configuration changes, and validation steps so that existing 0.x deployments can promote to v1.0 with zero surprises.

## Audience and prerequisites

### Supported starting points

- Official upgrade paths cover **v0.3.x** (middleware + module rollout) and **v0.4.x** (observability and resilience additions). Earlier releases should first fast-forward to the latest 0.4 patch to pick up the incremental deprecation warnings before attempting the major upgrade.
- Verify the current framework version before scheduling downtime:
  ```bash
  composer show greenarmor/bamboo | grep ^versions?
  php bin/bamboo pkg.info | head
  ```

### Environment readiness checklist

1. Ensure the PHP 8.4 runtime is available for both the CLI shebang (`bin/bamboo`) and web workers:
   ```bash
   php -v
   command -v php8.4
   ```
2. Confirm OpenSwoole is rebuilt against the target PHP binary and exposes coroutine, JSON, and OpenSSL support:
   ```bash
   php --ri openswoole | grep -E 'OpenSwoole Version|Coroutine|json|openssl'
   ```
3. Export a clean snapshot of project configuration and environment overrides before editing:
   ```bash
   git status
   tar -czf bamboo-config-backup.tgz etc/ .env*
   ```
4. Keep the [PHP 8.4 installation runbook](../Install-Bamboo-PHP84.md) and the [OpenSwoole compatibility notes](../OpenSwoole-Compat-and-Fixes.md) handy. They document the supported package sets, build flags, and troubleshooting steps referenced throughout this guide.

## Step-by-step upgrade flow

1. **Stabilise the deployment window**
   - Drain traffic or enable maintenance mode on upstream load balancers.
   - Record the active CLI commands (cron entries, supervisor units, systemd services) that invoke `bin/bamboo` so automation can be updated later.
   - If route caching is enabled, clear caches ahead of the upgrade to avoid stale data lingering in `var/cache/`.

2. **Validate configuration health before changing dependencies**
   - Run the bootstrapper to surface any pre-existing issues:
     ```bash
     php -d detect_unicode=0 ./bootstrap/app.php >/dev/null
     ```
     `ConfigValidator` now fails fast when critical keys are missing or malformed, so fix any reported errors before proceeding.
   - Capture diffs for custom `etc/*.php` files (`git diff etc/`)—you will merge upstream defaults later.

3. **Upgrade PHP and OpenSwoole**
   - Follow the distribution-specific steps in [Install-Bamboo-PHP84](../Install-Bamboo-PHP84.md) to install the PHP 8.4 CLI, development headers, and required extensions (`ext-openswoole`, `ext-curl`, `ext-json`, `ext-pdo_mysql`, etc.).
   - Rebuild OpenSwoole 25.x with `--enable-openssl --enable-swoole-curl --enable-swoole-json` as outlined in the [compatibility and fixes guide](../OpenSwoole-Compat-and-Fixes.md). Remove older `.so` builds before reinstalling to prevent ABI mismatches.
   - Restart background workers after the upgrade so they inherit the new binaries.

4. **Update Composer dependencies**
   - Ensure the repository's wrapper is on the `PATH` so Composer honours the PHP 8.4 runtime:
     ```bash
     eval "$(./bootstrap/shell-init.sh)"
     ```
   - Require Bamboo v1.0 and refresh the lock file:
     ```bash
     composer require greenarmor/bamboo:^1.0 --with-all-dependencies
     composer install --no-dev    # optional for production build artefacts
     ```
   - Re-run project-specific `composer install` hooks so that `app.key.make --if-missing` seeds `APP_KEY` and `cache.purge` clears stale caches.

5. **Align configuration, middleware, and modules**
   - Merge the new default configuration introduced across `etc/metrics.php`, `etc/resilience.php`, and `etc/middleware.php`. The global middleware stack now includes:
     - `Bamboo\Web\Middleware\RequestId`
     - `Bamboo\Web\Middleware\HttpMetricsCollector`
     - `Bamboo\Web\Middleware\CircuitBreakerMiddleware`
     - `Bamboo\Web\Middleware\TimeoutMiddleware`
   - Adopt the resilience configuration keys expected by `ConfigValidator` (`resilience.timeouts.*`, `resilience.circuit_breaker.*`, `resilience.health.dependencies`). The validator throws a `ConfigurationException` when defaults are missing, so populate environment overrides (`BAMBOO_HTTP_TIMEOUT_DEFAULT`, `BAMBOO_CIRCUIT_BREAKER_*`) where needed.
   - Review module registration in `etc/modules.php`. v1.0 rejects non-array return values and boot order changes are now observable via circuit-breaker metrics, so confirm modules still register in the intended sequence.
   - Reconcile local overrides with the schemas documented in the [configuration overview](../configuration/overview.md). Capture any custom knobs so they survive future scaffolding refreshes.

6. **Update automation and CLI usage**
   - `bin/bamboo` is now hard-pinned to `php8.4`. Update cron jobs, Supervisor definitions, or Docker entrypoints that previously invoked `php bin/bamboo` to call the wrapper directly so the correct interpreter is used.
   - Normalise scripts and documentation around the dot-notation command names enumerated in the [CLI reference](../cli/README.md). Legacy colon aliases are no longer shipped, and contract changes for preview commands are documented per-command.
   - Production rollouts should pre-warm caches with:
     ```bash
     php bin/bamboo routes.cache
     ```
     and clear them on rollback with `php bin/bamboo cache.purge` to keep OpenSwoole workers in sync.

7. **Validate the upgrade end-to-end**
   - Run the quality gates shipped with the framework:
     ```bash
     composer validate --strict
     composer lint
     composer stan
     composer test
     ```
   - Start the HTTP server and exercise the built-in health checks:
     ```bash
     php bin/bamboo http.serve &
     SERVER_PID=$!
     curl -f http://127.0.0.1:9501/healthz
     curl -f http://127.0.0.1:9501/readyz
     curl -f http://127.0.0.1:9501/metrics | head
     kill $SERVER_PID
     ```
   - Smoke-test queue and client integrations with `php bin/bamboo queue.work --once` and `php bin/bamboo client.call --url=https://httpbin.org/get`.
   - Once validation passes, re-enable traffic and monitor OpenSwoole logs plus the exported Prometheus metrics for anomalies.

## Compatibility matrix

### PHP runtimes

| Version | Support level | Notes |
|---------|---------------|-------|
| 8.2.x   | ❌ Not supported | Retired with v1.0. Composer now requires `^8.4` and the CLI wrapper shebang targets `php8.4` exclusively. |
| 8.3.x   | ⚠️ Build-time only | CI continues to exercise 8.3 to detect syntax regressions, but production deployments must run 8.4. Use only for local read-only tooling. |
| 8.4.x   | ✅ General availability | Primary runtime for v1.0. Required for OpenSwoole 25.x and the bundled Prometheus instrumentation. |

### OpenSwoole releases

| Release | Support level | Required build options |
|---------|---------------|------------------------|
| 25.0–25.2 | ✅ General availability | Build with `--enable-openssl --enable-swoole-curl --enable-swoole-json`. Matches the PHP 8.4 ABI. |
| 22.x–24.x | ⚠️ Transitional | Only suitable for local smoke tests using PHP 8.2/8.3. Missing coroutine fixes required by v1.0 middleware. |
| < 22.0   | ❌ Dropped | Legacy `swoole_*` APIs removed. Upgrade to a maintained OpenSwoole series before installing v1.0. |

### Third-party modules

- Modules compiled against Bamboo 0.3/0.4 continue to function provided they honour the `ModuleInterface` lifecycle and supply deterministic middleware arrays. See the [module extension guide](../modules.md) for validation strategies.
- Re-run module test suites against PHP 8.4 + OpenSwoole 25.x to confirm compatibility before publishing updates to packagist or private registries.

## Deprecations lifted in v1.0

| Removed behaviour (0.x) | Replacement in v1.0 |
|-------------------------|---------------------|
| Silently booting without a production `APP_KEY` when `APP_DEBUG` was false. | `ConfigValidator` now refuses to boot unless `app.key` is populated. Run `php bin/bamboo app.key.make --if-missing` during deployment. |
| Accepting empty or malformed Redis DSNs (`redis.url`) for the queue worker. | `ConfigValidator` enforces a non-empty DSN. Update `.env` to define `REDIS_URL` or extend `etc/redis.php` before running `queue.work`. |
| Permitting zero/negative HTTP client timeouts and missing retry metadata under `http.default`. | Populate `etc/http.php` with positive `timeout` values and the documented retry structure; downstream requests now inherit sane limits. |
| Allowing `etc/modules.php` to return non-arrays (null, string) without halting bootstrap. | The bootstrapper throws an `InvalidArgumentException` when the file does not return a list of class strings. Ensure module registries return arrays and cover them with configuration tests. |

## Additional resources

- [CLI reference](../cli/README.md) – command contracts, stability tiers, and guidance for automation scripts.
- [Configuration schema overview](../configuration/overview.md) – source-of-truth for `etc/*.php` keys, validation rules, and migration policy.
- [Starter blueprints hub](../starters/README.md) – curated `composer create-project` templates for REST, queue, and WebSocket workloads.
- [OpenSwoole compatibility playbook](../OpenSwoole-Compat-and-Fixes.md) – detailed extension rebuild instructions and troubleshooting checklists.
- [Router contract](../router.md) – HTTP surface guarantees and middleware ordering semantics to verify after the upgrade.

